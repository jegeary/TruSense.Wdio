"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var dotenv = require("dotenv");
dotenv.config();
var nodeSymbol = function (key) { return '__mts_' + key; };
var testNameSymbol = nodeSymbol('test');
var parametersSymbol = nodeSymbol('parametersSymbol');
var nameForParametersSymbol = nodeSymbol('nameForParameters');
var localhost = 'http://localhost';
var pmsUrl = process.env.PMS_URL || localhost;
var tmsUrl = process.env.TMS_URL || localhost;
function getAllure() {
    var allure = global.allure;
    if (!allure) {
        throw new Error('Unable to find AllureInterface in a global context');
    }
    return allure;
}
function makeParamsFunction(mark) {
    return function (params, name) {
        return function (target, propertyKey, descriptor) {
            target[propertyKey][testNameSymbol] = propertyKey.toString();
            target[propertyKey][parametersSymbol] = target[propertyKey][parametersSymbol] || [];
            [].concat(params || []).forEach(function (param) {
                target[propertyKey][parametersSymbol].push({ mark: mark, name: name, params: param });
            });
            return processDescriptor(function (args) { return args.toString(); }, function (arg) { return getAllure().addParameter('inputs', arg); }, descriptor);
        };
    };
}
function makeParamsNameFunction() {
    return function (nameForParameters) {
        return function (target, propertyKey, descriptor) {
            target[propertyKey][nameForParametersSymbol] = nameForParameters;
            return descriptor;
        };
    };
}
function makeParamsObject() {
    return Object.assign(makeParamsFunction(0), {
        only: makeParamsFunction(2),
        pending: makeParamsFunction(3),
        skip: makeParamsFunction(1),
        withCustomTestName: makeParamsNameFunction()
    });
}
function processDescriptor(parameterFn, reporterFn, descriptor) {
    var original = descriptor.value;
    if (typeof original === 'function') {
        descriptor.value = function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
            }
            try {
                var value = typeof parameterFn === 'function' ? parameterFn.apply(this, args) : parameterFn;
                reporterFn(value);
            }
            catch (e) {
                console.error("[ERROR] Failed to apply decorator: " + e);
            }
            return original.apply(this, args);
        };
    }
    for (var _i = 0, _a = Object.keys(original); _i < _a.length; _i++) {
        var prop = _a[_i];
        if (original.hasOwnProperty(prop) && prop.startsWith('__mts_')) {
            descriptor.value[prop] = original[prop];
        }
    }
    return descriptor;
}
function processDecorator(parameterFn, reporterFn) {
    return function (target, property, descriptor) {
        return processDescriptor(parameterFn, reporterFn, descriptor);
    };
}
function step(nameFn) {
    return function (target, property, descriptor) {
        var original = descriptor.value;
        var callable;
        if (typeof original === 'function') {
            descriptor.value = function () {
                var _this = this;
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                try {
                    var value_1 = typeof nameFn === 'function' ? nameFn.apply(this, args) : nameFn;
                    callable = function () { return getAllure().step(value_1, function () { return original.apply(_this, args); }); };
                }
                catch (e) {
                    console.error("[ERROR] Failed to apply decorator: " + e);
                }
                return callable.apply(this, args);
            };
        }
        return descriptor;
    };
}
exports.step = step;
function testCaseId(idFn) {
    return processDecorator(idFn, function (id) { return getAllure().addLink(id, tmsUrl + "/" + id, "tms"); });
}
exports.testCaseId = testCaseId;
function issue(idFn) {
    return processDecorator(idFn, function (id) { return getAllure().addLink(id, pmsUrl + "/" + id, "issue"); });
}
exports.issue = issue;
function feature(featureFn) {
    return processDecorator(featureFn, function (name) { return getAllure().feature(name); });
}
exports.feature = feature;
function story(storyFn) {
    return processDecorator(storyFn, function (name) { return getAllure().story(name); });
}
exports.story = story;
function severity(severityFn) {
    return processDecorator(severityFn, function (name) { return getAllure().severity(name); });
}
exports.severity = severity;
function tag(tagFn) {
    return processDecorator(tagFn, function (name) { return getAllure().addTag(name); });
}
exports.tag = tag;
function owner(ownerFn) {
    return processDecorator(ownerFn, function (name) { return getAllure().addOwner(name); });
}
exports.owner = owner;
function description(descriptionFn) {
    return processDecorator(descriptionFn, function (text) { return getAllure().setDescription(text); });
}
exports.description = description;
exports.data = makeParamsObject();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLCtCQUFpQztBQUVqQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7QUFFaEIsSUFBTSxVQUFVLEdBQUcsVUFBQyxHQUFHLElBQWEsT0FBQSxRQUFRLEdBQUcsR0FBRyxFQUFkLENBQWMsQ0FBQztBQUNuRCxJQUFNLGNBQWMsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDMUMsSUFBTSxnQkFBZ0IsR0FBRyxVQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUN4RCxJQUFNLHVCQUF1QixHQUFHLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBRWhFLElBQU0sU0FBUyxHQUFHLGtCQUFrQixDQUFDO0FBQ3JDLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxJQUFJLFNBQVMsQ0FBQztBQUNoRCxJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sSUFBSSxTQUFTLENBQUM7QUFjaEQsU0FBUyxTQUFTO0lBRWhCLElBQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDN0IsSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUNYLE1BQU0sSUFBSSxLQUFLLENBQUMsb0RBQW9ELENBQUMsQ0FBQztLQUN2RTtJQUNELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFFRCxTQUFTLGtCQUFrQixDQUFDLElBQVU7SUFDcEMsT0FBTyxVQUFDLE1BQVcsRUFBRSxJQUFhO1FBQ2hDLE9BQU8sVUFBQyxNQUFXLEVBQUUsV0FBbUIsRUFBRSxVQUFlO1lBQ3ZELE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxjQUFjLENBQUMsR0FBRyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDN0QsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsTUFBTSxDQUFD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QUFDO0FBQ25FLENBQUM7QUFGRCxrQkFFQztBQUVELFNBQWdCLEtBQUssQ0FBQyxPQUF3QztJQUM1RCxPQUFPLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxVQUFBLElBQUksSUFBSSxPQUFBLFNBQVMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBMUIsQ0FBMEIsQ0FBQyxDQUFDO0FBQ3ZFLENBQUM7QUFGRCxzQkFFQztBQUVELFNBQWdCLFdBQVcsQ0FBQyxhQUE4QztJQUN4RSxPQUFPLGdCQUFnQixDQUFDLGFBQWEsRUFBRSxVQUFBLElBQUksSUFBSSxPQUFBLFNBQVMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsRUFBaEMsQ0FBZ0MsQ0FBQyxDQUFDO0FBQ25GLENBQUM7QUFGRCxrQ0FFQztBQUVZLFFBQUEsSUFBSSxHQUFHLGdCQUFnQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbGx1cmVJbnRlcmZhY2UsIFNldmVyaXR5IH0gZnJvbSAnYWxsdXJlMi1qcy1jb21tb25zJztcbmltcG9ydCAqIGFzIGRvdGVudiBmcm9tICdkb3RlbnYnO1xuXG5kb3RlbnYuY29uZmlnKCk7XG5cbmNvbnN0IG5vZGVTeW1ib2wgPSAoa2V5KTogc3RyaW5nID0+ICdfX210c18nICsga2V5O1xuY29uc3QgdGVzdE5hbWVTeW1ib2wgPSBub2RlU3ltYm9sKCd0ZXN0Jyk7XG5jb25zdCBwYXJhbWV0ZXJzU3ltYm9sID0gbm9kZVN5bWJvbCgncGFyYW1ldGVyc1N5bWJvbCcpO1xuY29uc3QgbmFtZUZvclBhcmFtZXRlcnNTeW1ib2wgPSBub2RlU3ltYm9sKCduYW1lRm9yUGFyYW1ldGVycycpO1xuXG5jb25zdCBsb2NhbGhvc3QgPSAnaHR0cDovL2xvY2FsaG9zdCc7XG5jb25zdCBwbXNVcmwgPSBwcm9jZXNzLmVudi5QTVNfVVJMIHx8IGxvY2FsaG9zdDtcbmNvbnN0IHRtc1VybCA9IHByb2Nlc3MuZW52LlRNU19VUkwgfHwgbG9jYWxob3N0O1xuXG5jb25zdCBlbnVtIE1hcmsge1xuICB0ZXN0LFxuICBza2lwLFxuICBvbmx5LFxuICBwZW5kaW5nXG59XG5cbmNvbnN0IGVudW0gTGlua1R5cGUge1xuICBpc3N1ZSA9ICdpc3N1ZScsXG4gIHRtcyA9ICd0bXMnXG59XG5cbmZ1bmN0aW9uIGdldEFsbHVyZSgpOiBBbGx1cmVJbnRlcmZhY2Uge1xuICAvLyBAdHMtaWdub3JlXG4gIGNvbnN0IGFsbHVyZSA9IGdsb2JhbC5hbGx1cmU7XG4gIGlmICghYWxsdXJlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdVbmFibGUgdG8gZmluZCBBbGx1cmVJbnRlcmZhY2UgaW4gYSBnbG9iYWwgY29udGV4dCcpO1xuICB9XG4gIHJldHVybiBhbGx1cmU7XG59XG5cbmZ1bmN0aW9uIG1ha2VQYXJhbXNGdW5jdGlvbihtYXJrOiBNYXJrKSB7XG4gIHJldHVybiAocGFyYW1zOiBhbnksIG5hbWU/OiBzdHJpbmcpID0+IHtcbiAgICByZXR1cm4gKHRhcmdldDogYW55LCBwcm9wZXJ0eUtleTogc3RyaW5nLCBkZXNjcmlwdG9yOiBhbnkpID0+IHtcbiAgICAgIHRhcmdldFtwcm9wZXJ0eUtleV1bdGVzdE5hbWVTeW1ib2xdID0gcHJvcGVydHlLZXkudG9TdHJpbmcoKTtcbiAgICAgIHRhcmdldFtwcm9wZXJ0eUtleV1bcGFyYW1ldGVyc1N5bWJvbF0gPSB0YXJnZXRbcHJvcGVydHlLZXldW3BhcmFtZXRlcnNTeW1ib2xdIHx8IFtdO1xuICAgICAgW10uY29uY2F0KHBhcmFtcyB8fCBbXSkuZm9yRWFjaChwYXJhbSA9PiB7XG4gICAgICAgIHRhcmdldFtwcm9wZXJ0eUtleV1bcGFyYW1ldGVyc1N5bWJvbF0ucHVzaCh7IG1hcmssIG5hbWUsIHBhcmFtczogcGFyYW0gfSk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBwcm9jZXNzRGVzY3JpcHRvcihhcmdzID0+IGFyZ3MudG9TdHJpbmcoKSwgYXJnID0+IGdldEFsbHVyZSgpLmFkZFBhcmFtZXRlcignaW5wdXRzJywgYXJnKSwgZGVzY3JpcHRvcik7XG4gICAgfTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gbWFrZVBhcmFtc05hbWVGdW5jdGlvbigpIHtcbiAgcmV0dXJuIChuYW1lRm9yUGFyYW1ldGVyczogKHBhcmFtZXRlcnM6IGFueSkgPT4gc3RyaW5nKSA9PiB7XG4gICAgcmV0dXJuICh0YXJnZXQ6IGFueSwgcHJvcGVydHlLZXk6IHN0cmluZywgZGVzY3JpcHRvcjogYW55KSA9PiB7XG4gICAgICB0YXJnZXRbcHJvcGVydHlLZXldW25hbWVGb3JQYXJhbWV0ZXJzU3ltYm9sXSA9IG5hbWVGb3JQYXJhbWV0ZXJzO1xuICAgICAgcmV0dXJuIGRlc2NyaXB0b3I7XG4gICAgfTtcbiAgfTtcbn1cblxuZnVuY3Rpb24gbWFrZVBhcmFtc09iamVjdCgpIHtcbiAgcmV0dXJuIE9iamVjdC5hc3NpZ24obWFrZVBhcmFtc0Z1bmN0aW9uKE1hcmsudGVzdCksIHtcbiAgICBvbmx5OiBtYWtlUGFyYW1zRnVuY3Rpb24oTWFyay5vbmx5KSxcbiAgICBwZW5kaW5nOiBtYWtlUGFyYW1zRnVuY3Rpb24oTWFyay5wZW5kaW5nKSxcbiAgICBza2lwOiBtYWtlUGFyYW1zRnVuY3Rpb24oTWFyay5za2lwKSxcbiAgICB3aXRoQ3VzdG9tVGVzdE5hbWU6IG1ha2VQYXJhbXNOYW1lRnVuY3Rpb24oKVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcHJvY2Vzc0Rlc2NyaXB0b3IoXG4gIHBhcmFtZXRlckZuOiBzdHJpbmcgfCAoKGFyZzogYW55KSA9PiBzdHJpbmcpLFxuICByZXBvcnRlckZuOiAoYXJnOiBzdHJpbmcpID0+IHZvaWQsXG4gIGRlc2NyaXB0b3I6IGFueVxuKSB7XG4gIGNvbnN0IG9yaWdpbmFsID0gZGVzY3JpcHRvci52YWx1ZTtcblxuICBpZiAodHlwZW9mIG9yaWdpbmFsID09PSAnZnVuY3Rpb24nKSB7XG4gICAgZGVzY3JpcHRvci52YWx1ZSA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gdHlwZW9mIHBhcmFtZXRlckZuID09PSAnZnVuY3Rpb24nID8gcGFyYW1ldGVyRm4uYXBwbHkodGhpcywgYXJncykgOiBwYXJhbWV0ZXJGbjtcbiAgICAgICAgcmVwb3J0ZXJGbih2YWx1ZSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYFtFUlJPUl0gRmFpbGVkIHRvIGFwcGx5IGRlY29yYXRvcjogJHtlfWApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3MpO1xuICAgIH07XG4gIH1cblxuICBmb3IgKGNvbnN0IHByb3Agb2YgT2JqZWN0LmtleXMob3JpZ2luYWwpKSB7XG4gICAgaWYgKG9yaWdpbmFsLmhhc093blByb3BlcnR5KHByb3ApICYmIHByb3Auc3RhcnRzV2l0aCgnX19tdHNfJykpIHtcbiAgICAgIGRlc2NyaXB0b3IudmFsdWVbcHJvcF0gPSBvcmlnaW5hbFtwcm9wXTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZGVzY3JpcHRvcjtcbn1cblxuZnVuY3Rpb24gcHJvY2Vzc0RlY29yYXRvcihwYXJhbWV0ZXJGbjogc3RyaW5nIHwgKChhcmc6IGFueSkgPT4gc3RyaW5nKSwgcmVwb3J0ZXJGbjogKGFyZzogc3RyaW5nKSA9PiB2b2lkKSB7XG4gIHJldHVybiAodGFyZ2V0LCBwcm9wZXJ0eSwgZGVzY3JpcHRvcikgPT4ge1xuICAgIHJldHVybiBwcm9jZXNzRGVzY3JpcHRvcihwYXJhbWV0ZXJGbiwgcmVwb3J0ZXJGbiwgZGVzY3JpcHRvcik7XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdGVwKG5hbWVGbjogc3RyaW5nIHwgKChhcmc6IGFueSkgPT4gc3RyaW5nKSkge1xuICByZXR1cm4gKHRhcmdldCwgcHJvcGVydHksIGRlc2NyaXB0b3IpID0+IHtcbiAgICBjb25zdCBvcmlnaW5hbCA9IGRlc2NyaXB0b3IudmFsdWU7XG4gICAgbGV0IGNhbGxhYmxlO1xuICAgIGlmICh0eXBlb2Ygb3JpZ2luYWwgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGRlc2NyaXB0b3IudmFsdWUgPSBmdW5jdGlvbiguLi5hcmdzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgdmFsdWUgPSB0eXBlb2YgbmFtZUZuID09PSAnZnVuY3Rpb24nID8gbmFtZUZuLmFwcGx5KHRoaXMsIGFyZ3MpIDogbmFtZUZuO1xuICAgICAgICAgIGNhbGxhYmxlID0gKCkgPT4gZ2V0QWxsdXJlKCkuc3RlcCh2YWx1ZSwgKCkgPT4gb3JpZ2luYWwuYXBwbHkodGhpcywgYXJncykpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGBbRVJST1JdIEZhaWxlZCB0byBhcHBseSBkZWNvcmF0b3I6ICR7ZX1gKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY2FsbGFibGUuYXBwbHkodGhpcywgYXJncyk7XG4gICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4gZGVzY3JpcHRvcjtcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRlc3RDYXNlSWQoaWRGbjogc3RyaW5nIHwgKChhcmc6IGFueSkgPT4gc3RyaW5nKSkge1xuICByZXR1cm4gcHJvY2Vzc0RlY29yYXRvcihpZEZuLCBpZCA9PiBnZXRBbGx1cmUoKS5hZGRMaW5rKGlkLCBgJHt0bXNVcmx9LyR7aWR9YCwgTGlua1R5cGUudG1zKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc3N1ZShpZEZuOiBzdHJpbmcgfCAoKGFyZzogYW55KSA9PiBzdHJpbmcpKSB7XG4gIHJldHVybiBwcm9jZXNzRGVjb3JhdG9yKGlkRm4sIGlkID0+IGdldEFsbHVyZSgpLmFkZExpbmsoaWQsIGAke3Btc1VybH0vJHtpZH1gLCBMaW5rVHlwZS5pc3N1ZSkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmVhdHVyZShmZWF0dXJlRm46IHN0cmluZyB8ICgoYXJnOiBhbnkpID0+IHN0cmluZykpIHtcbiAgcmV0dXJuIHByb2Nlc3NEZWNvcmF0b3IoZmVhdHVyZUZuLCBuYW1lID0+IGdldEFsbHVyZSgpLmZlYXR1cmUobmFtZSkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3Rvcnkoc3RvcnlGbjogc3RyaW5nIHwgKChhcmc6IGFueSkgPT4gc3RyaW5nKSkge1xuICByZXR1cm4gcHJvY2Vzc0RlY29yYXRvcihzdG9yeUZuLCBuYW1lID0+IGdldEFsbHVyZSgpLnN0b3J5KG5hbWUpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldmVyaXR5KHNldmVyaXR5Rm46IFNldmVyaXR5IHwgc3RyaW5nIHwgKChhcmc6IGFueSkgPT4gc3RyaW5nKSkge1xuICByZXR1cm4gcHJvY2Vzc0RlY29yYXRvcihzZXZlcml0eUZuLCBuYW1lID0+IGdldEFsbHVyZSgpLnNldmVyaXR5KG5hbWUpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRhZyh0YWdGbjogc3RyaW5nIHwgKChhcmc6IGFueSkgPT4gc3RyaW5nKSkge1xuICByZXR1cm4gcHJvY2Vzc0RlY29yYXRvcih0YWdGbiwgbmFtZSA9PiBnZXRBbGx1cmUoKS5hZGRUYWcobmFtZSkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gb3duZXIob3duZXJGbjogc3RyaW5nIHwgKChhcmc6IGFueSkgPT4gc3RyaW5nKSkge1xuICByZXR1cm4gcHJvY2Vzc0RlY29yYXRvcihvd25lckZuLCBuYW1lID0+IGdldEFsbHVyZSgpLmFkZE93bmVyKG5hbWUpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlc2NyaXB0aW9uKGRlc2NyaXB0aW9uRm46IHN0cmluZyB8ICgoYXJnOiBhbnkpID0+IHN0cmluZykpIHtcbiAgcmV0dXJuIHByb2Nlc3NEZWNvcmF0b3IoZGVzY3JpcHRpb25GbiwgdGV4dCA9PiBnZXRBbGx1cmUoKS5zZXREZXNjcmlwdGlvbih0ZXh0KSk7XG59XG5cbmV4cG9ydCBjb25zdCBkYXRhID0gbWFrZVBhcmFtc09iamVjdCgpO1xuIl19